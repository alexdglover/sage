{{ template "header" .}}
<h2>Cash Flow Report</h2>
<div class="row">
  <div class="col-md-2"></div>
  <div class="col-md-8" style="max-height: 600px;">
    <div class="btn-group" style="width: 100%; padding-left: 10%; padding-right: 10%;" role="group" aria-label="date range buttons">
      <a type="button" class="btn {{ if eq .RelativeWindow "allTime" }}btn-dark{{else}}btn-outline-dark{{end}}" href="/cash-flow?relativeWindow=allTime">All time</a>
      <a type="button" class="btn {{ if eq .RelativeWindow "12" }}btn-dark{{else}}btn-outline-dark{{end}}" href="/cash-flow?relativeWindow=12">Last 12 months</a>
      <a type="button" class="btn {{ if eq .RelativeWindow "6" }}btn-dark{{else}}btn-outline-dark{{end}}" href="/cash-flow?relativeWindow=6">Last 6 months</a>
      <a type="button" class="btn {{ if eq .RelativeWindow "3" }}btn-dark{{else}}btn-outline-dark{{end}}" href="/cash-flow?relativeWindow=3">Last 3 months</a>
    </div>
    <canvas id="sankeyChart" style="width: 100%;"></canvas>
  </div>
  <div class="col-md-2"></div>
</div>

<script src="/assets/npm/chart.js@4.4.3/dist/chart.umd.js"></script>
<script src="/assets/npm/chartjs-chart-sankey@0.14.0/chartjs-chart-sankey.min.js"></script>
<script>
(function () {
  'use strict'
  var colors = {
    Income: "green",
    Savings: "green",
    Expenses: "red"
  };
  function getColor(txnType) {
    switch (true) {
      case txnType.toLowerCase().includes("income"):
      return 'green';
      case txnType.toLowerCase().includes("expenses"):
      return 'red';
      case txnType.toLowerCase().includes("net loss"):
      return 'red';
      case txnType.toLowerCase().includes("savings"):
      return 'green';
      default:
      return 'black'; // Default color if not found
    }
  }
  const totalIncomeLabel = "Total Income - ${{ .TotalIncomeHumanReadable }}";
  const totalExpenseLabel = "Expenses - ${{ .TotalExpensesHumanReadable }}";
  const netIncomeLabel = "{{ .NetIncomeLabel }} - ${{ .NetIncomeHumanReadable }}";
  const data = {
    datasets: [{
      label: 'Cash Flow',
      data: [
        { from: totalIncomeLabel, to: totalExpenseLabel, flow: {{ .TotalExpenses }} },
        {{ if eq .NetIncomeLabel "Net Income" }}
        { from: totalIncomeLabel, to: netIncomeLabel, flow: {{ .NetIncome }} },
        {{ else if eq .NetIncomeLabel "Net Loss" }}
        { from: totalExpenseLabel, to: netIncomeLabel, flow: {{ .NetIncome }} },
        {{ end }}
        {{ range $index, $expenseDatum := .Expenses }}
        { from: totalExpenseLabel, to: "{{ $expenseDatum.Name }} - ${{ $expenseDatum.Amount }}", flow: {{ $expenseDatum.Amount }} },
        {{ end }}
      ],
      colorFrom: (c) => getColor(c.dataset.data[c.dataIndex].from),
      colorTo: (c) => getColor(c.dataset.data[c.dataIndex].to),
      hoverColorFrom: (c) => getColor(c.dataset.data[c.dataIndex].from),
      hoverColorTo: (c) => getColor(c.dataset.data[c.dataIndex].to),
      colorMode: 'gradient',
      borderWidth: 0
    }]
  };

  const ctx = document.getElementById('sankeyChart').getContext('2d');
  new Chart(ctx, {
    type: 'sankey',
    data: data,
    options: {
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Cash Flow Sankey Diagram'
        }
      },
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: 20
      },
      animation: false
    }
  });
})();
</script>
{{ template "footer"}}
